# 特征和约束功能说明

## 功能概述

特征和约束功能允许用户在贝叶斯优化过程中添加线性约束，限制所有特征值的总和不超过指定值。这个功能特别适用于材料组分优化等场景，其中各组分的百分比总和需要满足特定约束（如总和≤100%或≤1）。

## 使用场景

### 1. 材料组分优化
- **场景**：优化合金材料中各元素的配比
- **约束**：所有元素的百分比总和≤100%
- **示例**：Fe-Cr-Ni合金中，Fe%+Cr%+Ni%≤100%

### 2. 配方优化
- **场景**：优化化学反应中各反应物的摩尔比
- **约束**：所有反应物的摩尔分数总和≤1
- **示例**：A+B+C→产物，其中xA+xB+xC≤1

### 3. 资源分配
- **场景**：优化有限资源在不同用途间的分配
- **约束**：所有分配比例的总和≤1
- **示例**：预算分配中，各项目分配比例总和≤100%

## 功能特点

### 1. 智能约束处理
- **拒绝采样**：自动过滤不满足约束的候选点
- **约束感知生成**：在生成新样本时考虑约束条件
- **效率优化**：批量生成和过滤以提高效率

### 2. 多算法支持
所有搜索策略都支持约束功能：
- **网格搜索**：过滤网格点以满足约束
- **随机搜索**：使用约束感知的随机采样
- **遗传算法**：约束感知的变异和交叉操作
- **粒子群优化**：约束边界处理
- **模拟退火**：约束感知的邻居生成

### 3. 用户友好界面
- **直观设置**：简单的复选框和数值输入
- **实时验证**：显示约束的合理性检查
- **智能提示**：提供约束值的建议范围

## 使用方法

### 1. 启用约束功能

在"搜索推荐"页面的"高级约束设置"部分：

1. 展开"特征和约束"折叠面板
2. 勾选"启用特征和约束"复选框
3. 设置"最大特征和"数值

### 2. 约束值设置指导

系统会自动显示当前特征范围下的：
- **最小可能和**：所有特征最小值的总和
- **最大可能和**：所有特征最大值的总和

**设置建议**：
- 约束值应大于最小可能和
- 约束值小于最大可能和才会起作用
- 常用值：1.0（归一化场景）或100（百分比场景）

### 3. 约束验证

系统提供实时反馈：
- ⚠️ **警告**：约束值过小，可能无法生成有效样本
- ℹ️ **提示**：约束值过大，约束不会起作用
- ✅ **正常**：约束值在合理范围内

## 技术实现

### 1. 约束应用函数
```python
def apply_sum_constraint(points, max_sum=None):
    """应用特征和约束，过滤不满足约束的点"""
    if max_sum is None:
        return points
    
    if isinstance(points, pd.DataFrame):
        row_sums = points.sum(axis=1)
        valid_mask = row_sums <= max_sum
        return points[valid_mask].reset_index(drop=True)
    # ... 处理numpy array
```

### 2. 约束采样函数
```python
def generate_constrained_samples(feature_ranges, n_points, max_sum=None):
    """生成满足约束的随机样本点"""
    # 使用拒绝采样策略
    # 批量生成候选样本
    # 过滤满足约束的样本
    # 返回所需数量的有效样本
```

### 3. 算法集成
每个搜索算法都通过以下方式支持约束：
- **初始化**：传递max_sum参数
- **采样**：使用约束感知的采样方法
- **过滤**：在关键步骤应用约束过滤
- **验证**：确保输出满足约束

## 性能考虑

### 1. 采样效率
- **批量处理**：一次生成多个候选样本
- **自适应策略**：根据约束紧度调整采样策略
- **早期终止**：达到所需样本数量后停止

### 2. 内存优化
- **流式处理**：避免一次性加载大量数据
- **增量过滤**：逐步过滤而非全量过滤
- **垃圾回收**：及时释放不需要的中间结果

### 3. 约束紧度处理
- **松约束**：约束值接近最大可能和，采样效率高
- **紧约束**：约束值接近最小可能和，需要更多尝试
- **无效约束**：约束值小于最小可能和，抛出错误

## 示例用法

### 示例1：三元合金优化
```python
# 特征范围设置
feature_ranges = {
    'Fe_percent': {'min': 60.0, 'max': 80.0, 'step': 2.0},
    'Cr_percent': {'min': 10.0, 'max': 25.0, 'step': 1.0},
    'Ni_percent': {'min': 5.0, 'max': 15.0, 'step': 1.0}
}

# 约束设置：总和不超过100%
max_sum = 100.0

# 在UI中：
# 1. 设置上述特征范围
# 2. 启用特征和约束
# 3. 设置最大特征和为100.0
# 4. 选择搜索策略并生成推荐
```

### 示例2：归一化组分优化
```python
# 特征范围设置（归一化）
feature_ranges = {
    'component_A': {'min': 0.0, 'max': 0.8, 'step': 0.05},
    'component_B': {'min': 0.0, 'max': 0.8, 'step': 0.05},
    'component_C': {'min': 0.0, 'max': 0.8, 'step': 0.05}
}

# 约束设置：总和不超过1.0
max_sum = 1.0
```

## 注意事项

### 1. 约束设计
- 确保约束值合理，不要过于严格
- 考虑特征范围与约束的兼容性
- 预留一定的约束余量

### 2. 性能影响
- 紧约束可能降低采样效率
- 大规模搜索时约束过滤可能耗时
- 建议先用小规模测试约束设置

### 3. 结果解释
- 约束可能减少可行解的数量
- 注意约束对优化结果的影响
- 必要时调整约束值或特征范围

## 故障排除

### 常见问题

1. **无法生成样本**
   - 检查约束值是否过于严格
   - 调整特征范围或放宽约束

2. **生成样本数量不足**
   - 增加最大尝试次数
   - 适当放宽约束条件

3. **约束不起作用**
   - 检查约束值是否大于最大可能和
   - 确认约束功能已正确启用

### 调试建议

1. 使用测试脚本验证约束功能
2. 检查日志输出中的约束相关信息
3. 逐步调整约束值观察效果
4. 对比有无约束的优化结果

## 更新日志

### v1.0.0 (2025-06-02)
- ✨ 新增特征和约束功能
- 🔧 支持所有搜索策略的约束处理
- 📱 添加用户友好的约束设置界面
- 🧪 提供完整的测试套件
- 📚 完善文档和使用指南